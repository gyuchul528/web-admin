<%- include('../../partials/admin/header') %>

<main class="px-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">写真アルバム管理</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="/admin/pictures/categories" class="btn btn-sm btn-outline-secondary">サブカテゴリー管理</a>
                <a href="/admin/pictures/create" class="btn btn-sm btn-primary">新規アルバム作成</a>
            </div>
        </div>
    </div>

    <% if (locals.message) { %>
        <div class="alert alert-<%= locals.messageType || 'info' %> alert-dismissible fade show" role="alert">
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <% if (locals.errorMessage) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= errorMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <!-- 操作結果メッセージ表示用 -->
    <div id="resultMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
        <span id="resultMessageText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>サムネイル</th>
                    <th>アルバム名</th>
                    <th>説明</th>
                    <th>写真数</th>
                    <th>作成日</th>
                    <th>更新日</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <% if (albums && albums.length > 0) { %>
                    <% albums.forEach(function(album) { %>
                        <tr>
                            <td><%= album.id %></td>
                            <td>
                                <% if (album.thumbnail) { %>
                                    <img src="<%= album.thumbnail %>" alt="<%= album.name %>" width="50" height="50">
                                <% } else { %>
                                    <img src="/images/no-image.jpg" alt="No Image" width="50" height="50">
                                <% } %>
                            </td>
                            <td><%= album.name %></td>
                            <td><%= album.description %></td>
                            <td><%= album.photo_count || 0 %></td>
                            <td><%= new Date(album.created_at).toLocaleString() %></td>
                            <td><%= new Date(album.updated_at).toLocaleString() %></td>
                            <td>
                                <div class="btn-group">
                                    <a href="/admin/pictures/<%= album.id %>/photos" class="btn btn-sm btn-outline-primary">写真管理</a>
                                    <a href="/admin/pictures/<%= album.id %>/edit" class="btn btn-sm btn-outline-secondary">編集</a>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-album" data-id="<%= album.id %>" data-name="<%= album.name %>">削除</button>
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="8" class="text-center">アルバムがありません</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>

    <!-- 削除確認モーダル -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">アルバム削除の確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage"></p>
                    <p class="text-danger">この操作は取り消せません。アルバム内の全ての写真も削除されます。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">削除する</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // モーダル要素の取得
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
        const resultMessage = document.getElementById('resultMessage');
        const resultMessageText = document.getElementById('resultMessageText');
        
        // 削除ボタンのイベントリスナー
        const deleteButtons = document.querySelectorAll('.delete-album');
        
        let currentAlbumId = null;
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const albumId = this.getAttribute('data-id');
                const albumName = this.getAttribute('data-name');
                
                // モーダルに情報をセット
                deleteConfirmMessage.textContent = `アルバム「${albumName}」を削除してもよろしいですか？`;
                currentAlbumId = albumId;
                
                // モーダルを表示
                deleteModal.show();
            });
        });
        
        // 削除確認ボタンのイベントリスナー
        confirmDeleteBtn.addEventListener('click', function() {
            if (!currentAlbumId) return;
            
            // ボタンを無効化して連打防止
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = '削除中...';
            
            // 非同期リクエストで削除処理を実行
            fetch(`/admin/pictures/11/album/delete/${currentAlbumId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                // レスポンスのステータスコードをチェック
                if (response.ok) {
                    // 成功した場合
                    deleteModal.hide();
                    
                    // 成功メッセージを表示
                    resultMessageText.textContent = 'アルバムが正常に削除されました';
                    resultMessage.classList.remove('alert-danger');
                    resultMessage.classList.add('alert-success');
                    resultMessage.style.display = 'block';
                    
                    // ページをリロード
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // エラーの場合
                    return response.json().then(data => {
                        throw new Error(data.message || 'アルバムの削除中にエラーが発生しました');
                    });
                }
            })
            .catch(error => {
                // エラーメッセージを表示
                deleteModal.hide();
                resultMessageText.textContent = error.message || 'アルバムの削除中にエラーが発生しました';
                resultMessage.classList.remove('alert-success');
                resultMessage.classList.add('alert-danger');
                resultMessage.style.display = 'block';
            })
            .finally(() => {
                // ボタンを元に戻す
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = '削除する';
                currentAlbumId = null;
            });
        });
    });
</script>

<%- include('../../partials/admin/footer') %> 