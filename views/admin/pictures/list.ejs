<%- include('../../partials/admin/header') %>

<div class="container-fluid">
    <div class="row">
        <!-- サイドバーを削除 -->
        
        <main class="col-md-12 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">写真アルバム管理</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="/admin/pictures/<%= category.id %>/subcategories" class="btn btn-sm btn-outline-secondary">サブカテゴリー管理</a>
                        <a href="/admin/pictures/<%= category.id %>/album/add" class="btn btn-sm btn-outline-primary">新規アルバム作成</a>
                    </div>
                </div>
            </div>

            <% if (typeof message !== 'undefined' && message) { %>
                <div class="alert alert-<%= messageType || 'info' %> alert-dismissible fade show" role="alert">
                    <%= message %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">サムネイル</th>
                            <th scope="col">アルバム名</th>
                            <th scope="col">説明</th>
                            <th scope="col">写真数</th>
                            <th scope="col">作成日</th>
                            <th scope="col">更新日</th>
                            <th scope="col">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (albums && albums.length > 0) { %>
                            <% albums.forEach(function(album) { %>
                                <tr>
                                    <td><%= album.id %></td>
                                    <td>
                                        <% if (album.thumbnail_url) { %>
                                            <img src="<%= album.thumbnail_url %>" alt="<%= album.name %>" width="50" height="50" class="img-thumbnail">
                                        <% } else { %>
                                            <div class="bg-light text-center" style="width: 50px; height: 50px; line-height: 50px;">No Image</div>
                                        <% } %>
                                    </td>
                                    <td><%= album.name %></td>
                                    <td><%= album.description || '-' %></td>
                                    <td><%= album.photo_count || 0 %></td>
                                    <td><%= album.formatted_created_at %></td>
                                    <td><%= album.formatted_updated_at %></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/admin/pictures/<%= category.id %>/album/<%= album.id %>/photos" class="btn btn-outline-primary">写真管理</a>
                                            <a href="/admin/pictures/<%= category.id %>/album/edit/<%= album.id %>" class="btn btn-outline-secondary">編集</a>
                                            <button type="button" class="btn btn-outline-danger delete-album" data-id="<%= album.id %>" data-name="<%= album.name %>">削除</button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center">アルバムがありません。新しいアルバムを作成してください。</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">アルバム削除の確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>アルバム「<span id="albumName"></span>」を削除してもよろしいですか？</p>
                <p class="text-danger">この操作は取り消せません。アルバム内の全ての写真も削除されます。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">削除する</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 削除ボタンのイベントリスナー
        const deleteButtons = document.querySelectorAll('.delete-album');
        const albumNameElement = document.getElementById('albumName');
        const confirmDeleteButton = document.getElementById('confirmDelete');
        let albumIdToDelete;

        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                albumIdToDelete = this.getAttribute('data-id');
                const albumName = this.getAttribute('data-name');
                albumNameElement.textContent = albumName;
                
                // モーダルを表示
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });
        });

        // 削除確認ボタンのイベントリスナー
        confirmDeleteButton.addEventListener('click', function() {
            if (albumIdToDelete) {
                // 削除リクエストを送信
                fetch(`/admin/pictures/<%= category.id %>/album/delete/${albumIdToDelete}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 成功したらページをリロード
                        window.location.reload();
                    } else {
                        alert('削除に失敗しました: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('削除処理中にエラーが発生しました');
                });
            }
        });
    });
</script>

<%- include('../../partials/admin/footer') %> 